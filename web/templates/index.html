<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="DuilioCode Studio - Your local AI coding assistant. 100% offline, 100% private.">
    <meta name="theme-color" content="#0d1117">
    <title>DuilioCode Studio</title>
    <link rel="icon" type="image/png" href="/static/images/logo-small.png">
    <link rel="apple-touch-icon" href="/static/images/logo.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --bg-active: #1f6feb22;
            --border-color: #30363d;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --text-muted: #6e7681;
            --accent-green: #3fb950;
            --accent-blue: #58a6ff;
            --accent-purple: #a371f7;
            --accent-orange: #d29922;
            --accent-red: #f85149;
            --accent-cyan: #39c5cf;
            --code-bg: #0d1117;
            --sidebar-width: 280px;
            --explorer-width: 260px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }

        /* Main Layout */
        .app-container {
            display: flex;
            height: 100vh;
        }

        /* Activity Bar (left icons) */
        .activity-bar {
            width: 48px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 0;
        }

        .activity-btn {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            border-radius: 8px;
            color: var(--text-muted);
            font-size: 20px;
            cursor: pointer;
            margin-bottom: 4px;
            transition: all 0.2s;
            position: relative;
        }

        .activity-btn:hover { background: var(--bg-tertiary); color: var(--text-primary); }
        .activity-btn.active { 
            color: var(--text-primary); 
            background: var(--bg-active);
        }
        .activity-btn.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 8px;
            bottom: 8px;
            width: 2px;
            background: var(--accent-blue);
            border-radius: 0 2px 2px 0;
        }

        .activity-spacer { flex: 1; }

        /* Explorer Panel */
        .explorer-panel {
            width: var(--explorer-width);
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .explorer-panel.hidden { display: none; }

        .explorer-header {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border-color);
        }

        .explorer-title {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-secondary);
            letter-spacing: 0.5px;
        }

        .explorer-actions {
            display: flex;
            gap: 4px;
        }

        .explorer-action {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            border-radius: 4px;
            color: var(--text-muted);
            font-size: 14px;
            cursor: pointer;
        }

        .explorer-action:hover { background: var(--bg-tertiary); color: var(--text-primary); }

        /* Workspace Selector */
        .workspace-selector {
            padding: 8px 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .workspace-path {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .workspace-path:hover { border-color: var(--accent-blue); }

        .workspace-path-icon { font-size: 16px; }
        .workspace-path-text {
            flex: 1;
            font-size: 12px;
            font-family: 'JetBrains Mono', monospace;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--text-secondary);
        }

        /* File Tree */
        .file-tree {
            flex: 1;
            overflow-y: auto;
            padding: 8px 0;
        }

        .tree-item {
            display: flex;
            align-items: center;
            padding: 4px 8px 4px 16px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.1s;
            user-select: none;
        }

        .tree-item:hover { background: var(--bg-tertiary); }
        .tree-item.selected { background: var(--bg-active); }

        .tree-item-icon {
            width: 20px;
            font-size: 14px;
            text-align: center;
            margin-right: 6px;
            flex-shrink: 0;
        }

        .tree-item-name {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .tree-item.folder > .tree-item-name { color: var(--text-primary); }
        .tree-item.file > .tree-item-name { color: var(--text-secondary); }

        .tree-item-actions {
            display: none;
            gap: 2px;
        }

        .tree-item:hover .tree-item-actions { display: flex; }

        .tree-action {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            border-radius: 4px;
            color: var(--text-muted);
            font-size: 12px;
            cursor: pointer;
        }

        .tree-action:hover { background: var(--bg-primary); color: var(--text-primary); }

        .tree-children {
            padding-left: 16px;
        }

        .tree-children.collapsed { display: none; }

        /* Main Content Area */
        .main-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Tabs Bar */
        .tabs-bar {
            display: flex;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            overflow-x: auto;
        }

        .tab {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: transparent;
            border: none;
            border-right: 1px solid var(--border-color);
            color: var(--text-secondary);
            font-size: 13px;
            cursor: pointer;
            white-space: nowrap;
        }

        .tab:hover { background: var(--bg-tertiary); }
        .tab.active { 
            background: var(--bg-primary); 
            color: var(--text-primary);
            border-bottom: 2px solid var(--accent-blue);
        }

        .tab-icon { font-size: 14px; }
        .tab-close {
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            font-size: 12px;
            opacity: 0;
        }

        .tab:hover .tab-close { opacity: 1; }
        .tab-close:hover { background: var(--bg-tertiary); }

        /* Editor / Chat Area */
        .content-area {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        /* Editor Panel */
        .editor-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .editor-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 16px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
        }

        .editor-path {
            font-size: 12px;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-muted);
        }

        .editor-actions { display: flex; gap: 8px; }

        .editor-btn {
            padding: 6px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .editor-btn:hover { background: var(--border-color); color: var(--text-primary); }
        .editor-btn.primary { background: var(--accent-green); border-color: var(--accent-green); color: var(--bg-primary); }
        .editor-btn.primary:hover { background: #46d158; }

        .editor-content {
            flex: 1;
            overflow: auto;
        }

        .code-editor {
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
            border: none;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            line-height: 1.6;
            padding: 16px;
            resize: none;
            outline: none;
            tab-size: 4;
        }

        /* Chat Panel */
        .chat-panel {
            width: 400px;
            border-left: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            background: var(--bg-secondary);
        }

        .chat-panel.expanded { width: 600px; }

        .chat-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .message {
            margin-bottom: 20px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .message-avatar {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .message-avatar.user { background: var(--accent-blue); }
        .message-avatar.assistant { background: linear-gradient(135deg, var(--accent-purple), var(--accent-blue)); }

        .message-sender { font-size: 12px; font-weight: 600; }
        .message-time { font-size: 11px; color: var(--text-muted); }

        .message-content {
            font-size: 14px;
            line-height: 1.6;
            padding-left: 32px;
        }

        .message-content pre {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
            overflow-x: auto;
            position: relative;
        }

        .message-content code {
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
        }

        .message-content pre code { background: none; padding: 0; }
        .message-content code:not(pre code) {
            background: var(--bg-tertiary);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
        }

        .apply-code-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            padding: 4px 10px;
            background: var(--accent-green);
            border: none;
            border-radius: 4px;
            color: var(--bg-primary);
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .message-content pre:hover .apply-code-btn { opacity: 1; }

        /* Chat Input */
        .chat-input-area {
            padding: 12px 16px;
            border-top: 1px solid var(--border-color);
        }

        .chat-input-wrapper {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            display: flex;
            align-items: flex-end;
            padding: 8px;
        }

        .chat-input-wrapper:focus-within { border-color: var(--accent-blue); }

        .chat-textarea {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 14px;
            padding: 6px 10px;
            resize: none;
            min-height: 24px;
            max-height: 150px;
            outline: none;
            line-height: 1.5;
        }

        .chat-textarea::placeholder { color: var(--text-muted); }

        .chat-send-btn {
            width: 32px;
            height: 32px;
            background: var(--accent-blue);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chat-send-btn:hover { background: #79b8ff; }
        .chat-send-btn:disabled { background: var(--bg-tertiary); color: var(--text-muted); cursor: not-allowed; }

        /* Model Selector in Chat */
        .model-selector-inline {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            margin-top: 8px;
        }

        .model-selector-inline label {
            font-size: 11px;
            color: var(--text-muted);
        }

        .model-selector-inline select {
            flex: 1;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            padding: 6px 10px;
            font-size: 12px;
            cursor: pointer;
        }

        /* Welcome Screen */
        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            padding: 40px;
        }

        .welcome-logo {
            margin-bottom: 24px;
        }
        
        .welcome-logo img {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            object-fit: cover;
            box-shadow: 0 8px 32px rgba(88, 166, 255, 0.3);
            border: 3px solid var(--accent-blue);
        }

        .welcome-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-blue));
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            margin-bottom: 24px;
        }

        .welcome-title { font-size: 28px; font-weight: 700; margin-bottom: 12px; }
        .welcome-subtitle {
            font-size: 16px;
            color: var(--text-secondary);
            max-width: 500px;
            line-height: 1.6;
            margin-bottom: 32px;
        }

        .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            max-width: 500px;
        }

        .quick-action {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-action:hover { border-color: var(--accent-blue); transform: translateY(-2px); }
        .quick-action-icon { font-size: 24px; margin-bottom: 8px; }
        .quick-action-title { font-size: 14px; font-weight: 600; margin-bottom: 4px; }
        .quick-action-desc { font-size: 12px; color: var(--text-secondary); }

        /* Typing Indicator */
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 8px 0;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--text-secondary);
            border-radius: 50%;
            animation: typingBounce 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typingBounce {
            0%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-6px); }
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay.active { display: flex; }

        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title { font-size: 16px; font-weight: 600; }
        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 20px;
            cursor: pointer;
        }

        .modal-body { padding: 20px; }

        .form-group { margin-bottom: 16px; }
        .form-group label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--text-secondary);
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
        }

        .form-input:focus { outline: none; border-color: var(--accent-blue); }

        /* Path Autocomplete Styles */
        .path-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 240px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
        }
        
        .path-suggestions.active { display: block; }
        
        .path-suggestion {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            cursor: pointer;
            transition: background 0.1s;
            border-bottom: 1px solid var(--border-color);
        }
        
        .path-suggestion:last-child { border-bottom: none; }
        .path-suggestion:hover,
        .path-suggestion.selected { background: var(--bg-active); }
        
        .path-suggestion-icon { font-size: 16px; }
        
        .path-suggestion-text {
            flex: 1;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            color: var(--text-primary);
        }
        
        .path-suggestion-name {
            color: var(--accent-blue);
            font-weight: 500;
        }
        
        .path-quick-btn {
            padding: 6px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .path-quick-btn:hover {
            background: var(--bg-active);
            border-color: var(--accent-blue);
            color: var(--text-primary);
        }

        .form-hint {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 6px;
        }

        .modal-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        /* Context Menu */
        .context-menu {
            position: fixed;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 6px 0;
            min-width: 180px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
            z-index: 1000;
            display: none;
        }

        .context-menu.active { display: block; }

        .context-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 14px;
            font-size: 13px;
            cursor: pointer;
            color: var(--text-primary);
        }

        .context-item:hover { background: var(--bg-tertiary); }
        .context-item.danger { color: var(--accent-red); }
        .context-divider { height: 1px; background: var(--border-color); margin: 6px 0; }

        /* Status Bar */
        .status-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 4px 16px;
            background: var(--accent-blue);
            color: white;
            font-size: 12px;
        }

        .status-left, .status-right { display: flex; align-items: center; gap: 16px; }
        .status-item { display: flex; align-items: center; gap: 6px; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Activity Bar -->
        <div class="activity-bar">
            <button class="activity-btn active" onclick="toggleExplorer()" title="Explorer (Ctrl+B)">üìÅ</button>
            <button class="activity-btn" onclick="showSearch()" title="Search (Ctrl+Shift+F)">üîç</button>
            <button class="activity-btn" onclick="showGit()" title="Source Control">üì¶</button>
            <div class="activity-spacer"></div>
            <button class="activity-btn" onclick="showSettings()" title="Settings">‚öôÔ∏è</button>
        </div>

        <!-- Explorer Panel -->
        <div class="explorer-panel" id="explorerPanel">
            <div class="explorer-header">
                <span class="explorer-title">Explorer</span>
                <div class="explorer-actions">
                    <button class="explorer-action" onclick="createNewFile()" title="New File">üìÑ</button>
                    <button class="explorer-action" onclick="createNewFolder()" title="New Folder">üìÅ</button>
                    <button class="explorer-action" onclick="refreshExplorer()" title="Refresh">üîÑ</button>
                </div>
            </div>

            <!-- Workspace Selector -->
            <div class="workspace-selector">
                <div class="workspace-path" onclick="openWorkspaceModal()">
                    <span class="workspace-path-icon">üìÇ</span>
                    <span class="workspace-path-text" id="workspacePathText">Select workspace...</span>
                    <span>‚ñº</span>
                </div>
            </div>

            <!-- File Tree -->
            <div class="file-tree" id="fileTree">
                <div style="padding: 20px; text-align: center; color: var(--text-muted);">
                    <p style="margin-bottom: 12px;">üëÜ Click above to open a folder</p>
                    <p style="font-size: 12px;">Or use <kbd style="background: var(--bg-tertiary); padding: 2px 6px; border-radius: 4px;">Ctrl+O</kbd></p>
                </div>
            </div>
        </div>

        <!-- Main Area -->
        <div class="main-area">
            <!-- Tabs Bar -->
            <div class="tabs-bar" id="tabsBar">
                <button class="tab active" data-tab="welcome">
                    <span class="tab-icon">üè†</span>
                    <span>Welcome</span>
                </button>
            </div>

            <!-- Content Area -->
            <div class="content-area">
                <!-- Editor Panel -->
                <div class="editor-panel" id="editorPanel">
                    <!-- Welcome Screen (shown by default) -->
                    <div class="welcome-screen" id="welcomeScreen">
                        <div class="welcome-logo">
                            <img src="/static/images/logo.png" alt="DuilioCode" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                            <div class="welcome-icon" style="display:none;">üöÄ</div>
                        </div>
                        <h2 class="welcome-title">Welcome to DuilioCode Studio</h2>
                        <p class="welcome-subtitle">
                            Your local AI coding assistant powered by <strong>Qwen2.5-Coder</strong>.<br>
                            100% offline. 100% private. Create, edit, and build software with AI.
                        </p>
                        <div class="quick-actions">
                            <div class="quick-action" onclick="openWorkspaceModal()">
                                <div class="quick-action-icon">üìÇ</div>
                                <div class="quick-action-title">Open Folder</div>
                                <div class="quick-action-desc">Start working in a project</div>
                            </div>
                            <div class="quick-action" onclick="createNewFile()">
                                <div class="quick-action-icon">üìÑ</div>
                                <div class="quick-action-title">New File</div>
                                <div class="quick-action-desc">Create a new file</div>
                            </div>
                            <div class="quick-action" onclick="quickPrompt('Create a Python Flask REST API with CRUD operations')">
                                <div class="quick-action-icon">‚ö°</div>
                                <div class="quick-action-title">Generate Project</div>
                                <div class="quick-action-desc">AI creates code for you</div>
                            </div>
                            <div class="quick-action" onclick="quickPrompt('Explain Clean Architecture with examples')">
                                <div class="quick-action-icon">üìö</div>
                                <div class="quick-action-title">Learn Concepts</div>
                                <div class="quick-action-desc">Ask about programming</div>
                            </div>
                        </div>
                    </div>

                    <!-- File Editor (hidden by default) -->
                    <div id="fileEditorContainer" style="display: none; flex: 1; flex-direction: column;">
                        <div class="editor-header">
                            <span class="editor-path" id="editorPath"></span>
                            <div class="editor-actions">
                                <button class="editor-btn" onclick="revertFile()">‚Ü©Ô∏è Revert</button>
                                <button class="editor-btn primary" onclick="saveCurrentFile()">üíæ Save</button>
                            </div>
                        </div>
                        <div class="editor-content">
                            <textarea class="code-editor" id="codeEditor" spellcheck="false"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Chat Panel -->
                <div class="chat-panel" id="chatPanel">
                    <div class="chat-header">
                        <div class="chat-title">
                            <span>ü§ñ</span>
                            <span>DuilioCode AI</span>
                        </div>
                        <div>
                            <button class="explorer-action" onclick="toggleChatSize()" title="Expand">‚¨ú</button>
                            <button class="explorer-action" onclick="clearChat()" title="Clear">üóëÔ∏è</button>
                        </div>
                    </div>

                    <div class="chat-messages" id="chatMessages">
                        <div class="message">
                            <div class="message-header">
                                <div class="message-avatar assistant">ü§ñ</div>
                                <span class="message-sender">DuilioCode</span>
                            </div>
                            <div class="message-content">
                                <p>Hello! I'm your local AI assistant. I can help you:</p>
                                <ul style="margin: 8px 0 0 16px; color: var(--text-secondary);">
                                    <li>Create entire projects and file structures</li>
                                    <li>Edit and refactor existing code</li>
                                    <li>Explain concepts and debug issues</li>
                                    <li>Generate scripts, pipelines, and configs</li>
                                </ul>
                                <p style="margin-top: 12px;">Open a folder to get started, or just ask me anything!</p>
                            </div>
                        </div>
                    </div>

                    <div class="chat-input-area">
                        <div class="chat-input-wrapper">
                            <textarea 
                                class="chat-textarea" 
                                id="chatInput" 
                                placeholder="Ask me to create files, explain code, or build projects..."
                                rows="1"
                                onkeydown="handleChatKeyDown(event)"
                                oninput="autoResizeChat(this)"
                            ></textarea>
                            <button class="chat-send-btn" onclick="sendMessage()" title="Send (Ctrl+Enter)">‚û§</button>
                        </div>
                        <div class="model-selector-inline">
                            <label>Model:</label>
                            <select id="modelSelect" onchange="updateModel()">
                                <option value="">Loading...</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Status Bar -->
            <div class="status-bar">
                <div class="status-left">
                    <span class="status-item" id="connectionStatus">
                        <span style="color: #3fb950;">‚óè</span> Connected
                    </span>
                </div>
                <div class="status-right">
                    <span class="status-item" id="cursorPosition">Ln 1, Col 1</span>
                    <span class="status-item" id="fileLanguage">Plain Text</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Workspace Modal -->
    <div class="modal-overlay" id="workspaceModal">
        <div class="modal" style="width: 520px;">
            <div class="modal-header">
                <span class="modal-title">üìÇ Open Folder</span>
                <button class="modal-close" onclick="closeWorkspaceModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Folder Path</label>
                    <div class="path-input-container" style="position: relative;">
                        <input type="text" 
                               class="form-input" 
                               id="workspaceInput" 
                               placeholder="Start typing a path... (e.g., ~/projects)"
                               autocomplete="off"
                               oninput="handlePathInput(this.value)"
                               onkeydown="handlePathKeydown(event)">
                        <div id="pathSuggestions" class="path-suggestions"></div>
                    </div>
                    <div class="path-quick-buttons" style="display: flex; gap: 8px; margin-top: 8px;">
                        <button class="path-quick-btn" onclick="setQuickPath('~')">
                            üè† Home
                        </button>
                        <button class="path-quick-btn" onclick="setQuickPath('~/Desktop')">
                            üñ•Ô∏è Desktop
                        </button>
                        <button class="path-quick-btn" onclick="setQuickPath('~/Documents')">
                            üìÑ Documents
                        </button>
                        <button class="path-quick-btn" onclick="setQuickPath('~/Downloads')">
                            üì• Downloads
                        </button>
                    </div>
                    <p class="form-hint" style="margin-top: 12px;">
                        üí° <strong>Tips:</strong> Type a path and suggestions will appear. Use <kbd>‚Üë</kbd>/<kbd>‚Üì</kbd> to navigate, <kbd>Tab</kbd> or <kbd>Enter</kbd> to select.
                    </p>
                </div>
                <div class="form-group">
                    <label>Recent Folders</label>
                    <div id="recentFolders" style="max-height: 120px; overflow-y: auto;"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="editor-btn" onclick="closeWorkspaceModal()">Cancel</button>
                <button class="editor-btn primary" onclick="openWorkspace()">Open Folder</button>
            </div>
        </div>
    </div>

    <!-- New File Modal -->
    <div class="modal-overlay" id="newFileModal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title" id="newFileModalTitle">üìÑ New File</span>
                <button class="modal-close" onclick="closeNewFileModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" class="form-input" id="newFileName" placeholder="filename.py">
                    <p class="form-hint">Enter the file or folder name. Include extension for files.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="editor-btn" onclick="closeNewFileModal()">Cancel</button>
                <button class="editor-btn primary" onclick="confirmCreateFile()">Create</button>
            </div>
        </div>
    </div>

    <!-- Context Menu -->
    <div class="context-menu" id="contextMenu">
        <div class="context-item" onclick="contextNewFile()">üìÑ New File</div>
        <div class="context-item" onclick="contextNewFolder()">üìÅ New Folder</div>
        <div class="context-divider"></div>
        <div class="context-item" onclick="contextRename()">‚úèÔ∏è Rename</div>
        <div class="context-item" onclick="contextCopyPath()">üìã Copy Path</div>
        <div class="context-divider"></div>
        <div class="context-item danger" onclick="contextDelete()">üóëÔ∏è Delete</div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.0/marked.min.js"></script>
    <script>
        // ============================================
        // STATE
        // ============================================
        let workspace = {
            currentPath: null,
            recentPaths: [],
            openFiles: []
        };
        let openTabs = [];
        let currentTab = 'welcome';
        let currentFile = null;
        let currentModel = 'qwen2.5-coder:14b';
        let messages = [];
        let isLoading = false;
        let contextMenuTarget = null;
        let originalFileContent = '';

        const API_BASE = '';

        // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', async () => {
            await loadWorkspace();
            await loadModels();
            await checkConnection();
            setInterval(checkConnection, 30000);

            // Keyboard shortcuts
            document.addEventListener('keydown', handleGlobalKeyDown);
            document.addEventListener('click', hideContextMenu);
            document.addEventListener('contextmenu', handleContextMenu);
        });

        async function loadWorkspace() {
            try {
                const response = await fetch(`${API_BASE}/api/workspace`);
                const data = await response.json();
                workspace = data;
                
                if (workspace.current_path) {
                    document.getElementById('workspacePathText').textContent = shortenPath(workspace.current_path);
                    await loadFileTree(workspace.current_path);
                }
            } catch (error) {
                console.error('Failed to load workspace:', error);
            }
        }

        function shortenPath(path) {
            const home = workspace.home_directory || '';
            if (path.startsWith(home)) {
                return '~' + path.slice(home.length);
            }
            return path;
        }

        // ============================================
        // FILE TREE
        // ============================================
        async function loadFileTree(path) {
            try {
                const response = await fetch(`${API_BASE}/api/workspace/tree?path=${encodeURIComponent(path)}&depth=3`);
                const tree = await response.json();
                renderFileTree(tree);
            } catch (error) {
                console.error('Failed to load file tree:', error);
            }
        }

        function renderFileTree(node, container = null) {
            if (!container) {
                container = document.getElementById('fileTree');
                container.innerHTML = '';
            }

            if (!node || !node.children) return;

            // Sort: folders first, then files
            const sorted = [...node.children].sort((a, b) => {
                if (a.is_directory && !b.is_directory) return -1;
                if (!a.is_directory && b.is_directory) return 1;
                return a.name.localeCompare(b.name);
            });

            sorted.forEach(item => {
                const div = document.createElement('div');
                div.className = `tree-item ${item.is_directory ? 'folder' : 'file'}`;
                div.dataset.path = item.path;
                div.dataset.isDir = item.is_directory;

                const icon = item.is_directory ? 'üìÅ' : getFileIcon(item.name);
                
                div.innerHTML = `
                    <span class="tree-item-icon">${icon}</span>
                    <span class="tree-item-name">${item.name}</span>
                    <div class="tree-item-actions">
                        ${item.is_directory ? '<button class="tree-action" onclick="event.stopPropagation(); createInFolder(\'' + item.path + '\')">+</button>' : ''}
                    </div>
                `;

                div.onclick = (e) => {
                    e.stopPropagation();
                    if (item.is_directory) {
                        toggleFolder(div, item);
                    } else {
                        openFile(item.path);
                    }
                };

                container.appendChild(div);

                if (item.is_directory && item.children && item.children.length > 0) {
                    const childContainer = document.createElement('div');
                    childContainer.className = 'tree-children collapsed';
                    childContainer.id = `children-${item.path.replace(/[^a-zA-Z0-9]/g, '_')}`;
                    container.appendChild(childContainer);
                    renderFileTree(item, childContainer);
                }
            });
        }

        async function toggleFolder(element, item) {
            const childId = `children-${item.path.replace(/[^a-zA-Z0-9]/g, '_')}`;
            const childContainer = document.getElementById(childId);
            
            if (childContainer) {
                childContainer.classList.toggle('collapsed');
                const icon = element.querySelector('.tree-item-icon');
                icon.textContent = childContainer.classList.contains('collapsed') ? 'üìÅ' : 'üìÇ';
            }
        }

        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const icons = {
                'py': 'üêç', 'js': 'üìú', 'ts': 'üí†', 'jsx': '‚öõÔ∏è', 'tsx': '‚öõÔ∏è',
                'kt': 'üü£', 'java': '‚òï', 'go': 'üêπ', 'rs': 'ü¶Ä', 'cpp': '‚öôÔ∏è', 'c': '‚öôÔ∏è',
                'html': 'üåê', 'css': 'üé®', 'scss': 'üé®', 'json': 'üìã', 'yaml': 'üìã', 'yml': 'üìã',
                'md': 'üìù', 'txt': 'üìÑ', 'sh': 'üíª', 'bash': 'üíª',
                'sql': 'üóÉÔ∏è', 'xml': 'üì∞', 'svg': 'üñºÔ∏è', 'png': 'üñºÔ∏è', 'jpg': 'üñºÔ∏è',
                'pdf': 'üìï', 'zip': 'üì¶', 'tar': 'üì¶', 'gz': 'üì¶',
                'swift': 'üçé', 'rb': 'üíé', 'php': 'üêò', 'vue': 'üíö', 'svelte': 'üî•'
            };
            return icons[ext] || 'üìÑ';
        }

        // ============================================
        // FILE OPERATIONS
        // ============================================
        async function openFile(path) {
            try {
                const response = await fetch(`${API_BASE}/api/files/read?path=${encodeURIComponent(path)}`);
                const data = await response.json();

                currentFile = {
                    path: data.path,
                    content: data.content,
                    language: data.language
                };
                originalFileContent = data.content;

                // Add to tabs
                addTab(path, data.language);

                // Show editor
                document.getElementById('welcomeScreen').style.display = 'none';
                document.getElementById('fileEditorContainer').style.display = 'flex';
                document.getElementById('editorPath').textContent = shortenPath(path);
                document.getElementById('codeEditor').value = data.content;
                document.getElementById('fileLanguage').textContent = data.language;

                // Highlight selection in tree
                document.querySelectorAll('.tree-item').forEach(el => el.classList.remove('selected'));
                const treeItem = document.querySelector(`.tree-item[data-path="${path}"]`);
                if (treeItem) treeItem.classList.add('selected');

            } catch (error) {
                alert('Error opening file: ' + error.message);
            }
        }

        async function saveCurrentFile() {
            if (!currentFile) return;

            const content = document.getElementById('codeEditor').value;

            try {
                await fetch(`${API_BASE}/api/files/write`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ path: currentFile.path, content })
                });

                originalFileContent = content;
                showNotification('File saved successfully!', 'success');
            } catch (error) {
                alert('Error saving file: ' + error.message);
            }
        }

        function revertFile() {
            if (currentFile && originalFileContent) {
                document.getElementById('codeEditor').value = originalFileContent;
            }
        }

        async function createNewFile(inPath = null) {
            document.getElementById('newFileModalTitle').textContent = 'üìÑ New File';
            document.getElementById('newFileName').value = '';
            document.getElementById('newFileName').dataset.isDir = 'false';
            document.getElementById('newFileName').dataset.basePath = inPath || workspace.current_path || '';
            document.getElementById('newFileModal').classList.add('active');
            setTimeout(() => document.getElementById('newFileName').focus(), 100);
        }

        async function createNewFolder(inPath = null) {
            document.getElementById('newFileModalTitle').textContent = 'üìÅ New Folder';
            document.getElementById('newFileName').value = '';
            document.getElementById('newFileName').dataset.isDir = 'true';
            document.getElementById('newFileName').dataset.basePath = inPath || workspace.current_path || '';
            document.getElementById('newFileModal').classList.add('active');
            setTimeout(() => document.getElementById('newFileName').focus(), 100);
        }

        function createInFolder(path) {
            createNewFile(path);
        }

        async function confirmCreateFile() {
            const input = document.getElementById('newFileName');
            const name = input.value.trim();
            const isDir = input.dataset.isDir === 'true';
            const basePath = input.dataset.basePath;

            if (!name) {
                alert('Please enter a name');
                return;
            }

            const fullPath = basePath ? `${basePath}/${name}` : name;

            try {
                await fetch(`${API_BASE}/api/files/create`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ path: fullPath, is_directory: isDir, content: '' })
                });

                closeNewFileModal();
                await refreshExplorer();

                if (!isDir) {
                    openFile(fullPath);
                }
            } catch (error) {
                alert('Error creating: ' + error.message);
            }
        }

        function closeNewFileModal() {
            document.getElementById('newFileModal').classList.remove('active');
        }

        async function deleteFile(path) {
            if (!confirm(`Are you sure you want to delete "${path}"?`)) return;

            try {
                await fetch(`${API_BASE}/api/files/delete`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ path })
                });

                await refreshExplorer();
                
                // Close tab if open
                if (currentFile && currentFile.path === path) {
                    closeTab(path);
                }
            } catch (error) {
                alert('Error deleting: ' + error.message);
            }
        }

        async function refreshExplorer() {
            if (workspace.current_path) {
                await loadFileTree(workspace.current_path);
            }
        }

        // ============================================
        // TABS
        // ============================================
        function addTab(path, language) {
            const name = path.split('/').pop();
            const existing = openTabs.find(t => t.path === path);
            
            if (!existing) {
                openTabs.push({ path, name, language });
            }

            renderTabs();
            selectTab(path);
        }

        function renderTabs() {
            const container = document.getElementById('tabsBar');
            container.innerHTML = '';

            // Welcome tab
            const welcomeTab = document.createElement('button');
            welcomeTab.className = `tab ${currentTab === 'welcome' ? 'active' : ''}`;
            welcomeTab.innerHTML = '<span class="tab-icon">üè†</span><span>Welcome</span>';
            welcomeTab.onclick = () => selectTab('welcome');
            container.appendChild(welcomeTab);

            // File tabs
            openTabs.forEach(tab => {
                const tabEl = document.createElement('button');
                tabEl.className = `tab ${currentTab === tab.path ? 'active' : ''}`;
                tabEl.innerHTML = `
                    <span class="tab-icon">${getFileIcon(tab.name)}</span>
                    <span>${tab.name}</span>
                    <span class="tab-close" onclick="event.stopPropagation(); closeTab('${tab.path}')">√ó</span>
                `;
                tabEl.onclick = () => selectTab(tab.path);
                container.appendChild(tabEl);
            });
        }

        function selectTab(id) {
            currentTab = id;
            renderTabs();

            if (id === 'welcome') {
                document.getElementById('welcomeScreen').style.display = 'flex';
                document.getElementById('fileEditorContainer').style.display = 'none';
                currentFile = null;
            } else {
                openFile(id);
            }
        }

        function closeTab(path) {
            openTabs = openTabs.filter(t => t.path !== path);
            
            if (currentTab === path) {
                if (openTabs.length > 0) {
                    selectTab(openTabs[openTabs.length - 1].path);
                } else {
                    selectTab('welcome');
                }
            } else {
                renderTabs();
            }
        }

        // ============================================
        // WORKSPACE
        // ============================================
        function openWorkspaceModal() {
            document.getElementById('workspaceInput').value = workspace.current_path || '';
            renderRecentFolders();
            document.getElementById('workspaceModal').classList.add('active');
            setTimeout(() => document.getElementById('workspaceInput').focus(), 100);
        }

        function closeWorkspaceModal() {
            document.getElementById('workspaceModal').classList.remove('active');
        }

        function renderRecentFolders() {
            const container = document.getElementById('recentFolders');
            const recent = workspace.recent_paths || [];

            if (recent.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted); font-size: 12px;">No recent folders</p>';
                return;
            }

            container.innerHTML = recent.map(path => `
                <div class="workspace-path" onclick="selectRecentFolder('${path}')" style="margin-bottom: 8px;">
                    <span class="workspace-path-icon">üìÇ</span>
                    <span class="workspace-path-text">${shortenPath(path)}</span>
                </div>
            `).join('');
        }

        function selectRecentFolder(path) {
            document.getElementById('workspaceInput').value = path;
        }

        async function openWorkspace() {
            const path = document.getElementById('workspaceInput').value.trim();
            if (!path) {
                alert('Please enter a folder path');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/workspace`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ path })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail);
                }

                workspace = await response.json();
                document.getElementById('workspacePathText').textContent = shortenPath(workspace.current_path);
                await loadFileTree(workspace.current_path);
                closeWorkspaceModal();

            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // ============================================
        // PATH AUTOCOMPLETE
        // ============================================
        let pathSuggestions = [];
        let selectedSuggestionIndex = -1;
        let autocompleteTimeout = null;

        async function handlePathInput(value) {
            // Debounce the autocomplete requests
            clearTimeout(autocompleteTimeout);
            
            if (!value || value.length < 1) {
                hidePathSuggestions();
                return;
            }

            autocompleteTimeout = setTimeout(async () => {
                await fetchPathSuggestions(value);
            }, 150);
        }

        async function fetchPathSuggestions(partial) {
            try {
                const response = await fetch(`${API_BASE}/api/files/autocomplete?partial=${encodeURIComponent(partial)}`);
                const data = await response.json();
                
                pathSuggestions = data.suggestions || [];
                selectedSuggestionIndex = -1;
                renderPathSuggestions();
            } catch (error) {
                console.error('Autocomplete error:', error);
                hidePathSuggestions();
            }
        }

        function renderPathSuggestions() {
            const container = document.getElementById('pathSuggestions');
            
            if (pathSuggestions.length === 0) {
                hidePathSuggestions();
                return;
            }

            container.innerHTML = pathSuggestions.map((item, index) => `
                <div class="path-suggestion ${index === selectedSuggestionIndex ? 'selected' : ''}"
                     onclick="selectPathSuggestion(${index})"
                     onmouseenter="selectedSuggestionIndex = ${index}; highlightSuggestion()">
                    <span class="path-suggestion-icon">üìÅ</span>
                    <span class="path-suggestion-text">
                        <span class="path-suggestion-name">${item.name}</span>
                        <span style="color: var(--text-muted); margin-left: 8px;">${item.path}</span>
                    </span>
                </div>
            `).join('');
            
            container.classList.add('active');
        }

        function hidePathSuggestions() {
            const container = document.getElementById('pathSuggestions');
            container.classList.remove('active');
            pathSuggestions = [];
            selectedSuggestionIndex = -1;
        }

        function highlightSuggestion() {
            const items = document.querySelectorAll('.path-suggestion');
            items.forEach((item, idx) => {
                item.classList.toggle('selected', idx === selectedSuggestionIndex);
            });
        }

        function selectPathSuggestion(index) {
            if (index >= 0 && index < pathSuggestions.length) {
                const suggestion = pathSuggestions[index];
                const input = document.getElementById('workspaceInput');
                input.value = suggestion.path + '/';
                hidePathSuggestions();
                input.focus();
                // Trigger another fetch for subdirectories
                handlePathInput(input.value);
            }
        }

        function handlePathKeydown(event) {
            const container = document.getElementById('pathSuggestions');
            const isVisible = container.classList.contains('active');

            if (!isVisible) {
                if (event.key === 'Enter') {
                    openWorkspace();
                }
                return;
            }

            switch (event.key) {
                case 'ArrowDown':
                    event.preventDefault();
                    selectedSuggestionIndex = Math.min(selectedSuggestionIndex + 1, pathSuggestions.length - 1);
                    highlightSuggestion();
                    scrollSuggestionIntoView();
                    break;
                case 'ArrowUp':
                    event.preventDefault();
                    selectedSuggestionIndex = Math.max(selectedSuggestionIndex - 1, 0);
                    highlightSuggestion();
                    scrollSuggestionIntoView();
                    break;
                case 'Tab':
                case 'Enter':
                    event.preventDefault();
                    if (selectedSuggestionIndex >= 0) {
                        selectPathSuggestion(selectedSuggestionIndex);
                    } else if (pathSuggestions.length > 0) {
                        selectPathSuggestion(0);
                    } else if (event.key === 'Enter') {
                        openWorkspace();
                    }
                    break;
                case 'Escape':
                    hidePathSuggestions();
                    break;
            }
        }

        function scrollSuggestionIntoView() {
            const selected = document.querySelector('.path-suggestion.selected');
            if (selected) {
                selected.scrollIntoView({ block: 'nearest' });
            }
        }

        function setQuickPath(path) {
            const input = document.getElementById('workspaceInput');
            input.value = path + '/';
            input.focus();
            handlePathInput(input.value);
        }

        // ============================================
        // CHAT
        // ============================================
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message || isLoading) return;

            addChatMessage('user', message);
            input.value = '';
            autoResizeChat(input);

            isLoading = true;
            const loadingEl = addLoadingMessage();

            try {
                // Include workspace context
                let context = messages.slice(-10).map(m => `${m.role}: ${m.content}`).join('\n');
                
                if (workspace.current_path) {
                    context = `Current workspace: ${workspace.current_path}\n${context}`;
                }

                const response = await fetch(`${API_BASE}/api/code`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: message,
                        model: currentModel,
                        context
                    })
                });

                const data = await response.json();
                removeLoadingMessage(loadingEl);

                if (data.response) {
                    addChatMessage('assistant', data.response);
                } else if (data.error) {
                    addChatMessage('assistant', `‚ùå Error: ${data.error}`);
                }
            } catch (error) {
                removeLoadingMessage(loadingEl);
                addChatMessage('assistant', `‚ùå Connection error: ${error.message}`);
            }

            isLoading = false;
        }

        function addChatMessage(role, content) {
            messages.push({ role, content });

            const container = document.getElementById('chatMessages');
            const messageEl = document.createElement('div');
            messageEl.className = 'message';

            const time = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            const avatar = role === 'user' ? 'üë§' : 'ü§ñ';
            const name = role === 'user' ? 'You' : 'DuilioCode';

            // Process markdown and add apply buttons to code blocks
            let htmlContent = marked.parse(content);
            
            messageEl.innerHTML = `
                <div class="message-header">
                    <div class="message-avatar ${role}">${avatar}</div>
                    <span class="message-sender">${name}</span>
                    <span class="message-time">${time}</span>
                </div>
                <div class="message-content">${htmlContent}</div>
            `;

            container.appendChild(messageEl);

            // Add apply/copy buttons to code blocks
            messageEl.querySelectorAll('pre code').forEach((block, index) => {
                hljs.highlightElement(block);
                
                const pre = block.parentElement;
                const codeContent = block.textContent;
                
                // Detect if this looks like a file content
                const hasPath = codeContent.includes('/') || codeContent.includes('\\');
                
                const btnContainer = document.createElement('div');
                btnContainer.style.cssText = 'position: absolute; top: 8px; right: 8px; display: flex; gap: 4px; opacity: 0; transition: opacity 0.2s;';
                btnContainer.innerHTML = `
                    <button class="apply-code-btn" onclick="copyCode(this, \`${encodeURIComponent(codeContent)}\`)" style="background: var(--bg-tertiary);">üìã Copy</button>
                    ${currentFile ? `<button class="apply-code-btn" onclick="applyCode(\`${encodeURIComponent(codeContent)}\`)">‚úÖ Apply</button>` : ''}
                `;
                
                pre.style.position = 'relative';
                pre.appendChild(btnContainer);
                pre.onmouseenter = () => btnContainer.style.opacity = '1';
                pre.onmouseleave = () => btnContainer.style.opacity = '0';
            });

            container.scrollTop = container.scrollHeight;
        }

        function addLoadingMessage() {
            const container = document.getElementById('chatMessages');
            const loadingEl = document.createElement('div');
            loadingEl.className = 'message';
            loadingEl.id = 'loading-message';
            loadingEl.innerHTML = `
                <div class="message-header">
                    <div class="message-avatar assistant">ü§ñ</div>
                    <span class="message-sender">DuilioCode</span>
                </div>
                <div class="message-content">
                    <div class="typing-indicator">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            `;
            container.appendChild(loadingEl);
            container.scrollTop = container.scrollHeight;
            return loadingEl;
        }

        function removeLoadingMessage(el) {
            if (el && el.parentNode) el.remove();
        }

        function copyCode(btn, encoded) {
            const code = decodeURIComponent(encoded);
            navigator.clipboard.writeText(code).then(() => {
                btn.textContent = '‚úÖ Copied!';
                setTimeout(() => btn.textContent = 'üìã Copy', 2000);
            });
        }

        function applyCode(encoded) {
            const code = decodeURIComponent(encoded);
            if (currentFile) {
                document.getElementById('codeEditor').value = code;
                showNotification('Code applied! Remember to save.', 'info');
            }
        }

        function clearChat() {
            if (confirm('Clear conversation?')) {
                messages = [];
                document.getElementById('chatMessages').innerHTML = '';
            }
        }

        function quickPrompt(text) {
            document.getElementById('chatInput').value = text;
            sendMessage();
        }

        // ============================================
        // MODELS
        // ============================================
        async function loadModels() {
            try {
                const response = await fetch('http://localhost:11434/api/tags');
                const data = await response.json();
                const models = (data.models || []).map(m => m.name);

                const select = document.getElementById('modelSelect');
                
                if (models.length > 0) {
                    select.innerHTML = models.map(m => 
                        `<option value="${m}" ${m.includes('coder') ? 'selected' : ''}>${m}</option>`
                    ).join('');
                    currentModel = select.value;
                } else {
                    select.innerHTML = '<option disabled>No models found</option>';
                }
            } catch (error) {
                document.getElementById('modelSelect').innerHTML = '<option disabled>Ollama not connected</option>';
            }
        }

        function updateModel() {
            currentModel = document.getElementById('modelSelect').value;
        }

        // ============================================
        // UI HELPERS
        // ============================================
        function toggleExplorer() {
            const panel = document.getElementById('explorerPanel');
            panel.classList.toggle('hidden');
            document.querySelector('.activity-btn').classList.toggle('active');
        }

        function toggleChatSize() {
            document.getElementById('chatPanel').classList.toggle('expanded');
        }

        function autoResizeChat(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 150) + 'px';
        }

        function handleChatKeyDown(event) {
            if (event.key === 'Enter' && event.ctrlKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function handleGlobalKeyDown(event) {
            // Ctrl+S - Save
            if (event.ctrlKey && event.key === 's') {
                event.preventDefault();
                saveCurrentFile();
            }
            // Ctrl+O - Open folder
            if (event.ctrlKey && event.key === 'o') {
                event.preventDefault();
                openWorkspaceModal();
            }
            // Ctrl+B - Toggle explorer
            if (event.ctrlKey && event.key === 'b') {
                event.preventDefault();
                toggleExplorer();
            }
        }

        async function checkConnection() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                const statusEl = document.getElementById('connectionStatus');
                
                if (data.ollama === 'connected') {
                    statusEl.innerHTML = '<span style="color: #3fb950;">‚óè</span> Connected';
                } else {
                    statusEl.innerHTML = '<span style="color: #d29922;">‚óè</span> Ollama offline';
                }
            } catch {
                document.getElementById('connectionStatus').innerHTML = '<span style="color: #f85149;">‚óè</span> Disconnected';
            }
        }

        function showNotification(message, type = 'info') {
            // Simple notification - could be enhanced
            console.log(`[${type}] ${message}`);
        }

        // ============================================
        // CONTEXT MENU
        // ============================================
        function handleContextMenu(event) {
            const treeItem = event.target.closest('.tree-item');
            if (treeItem) {
                event.preventDefault();
                contextMenuTarget = {
                    path: treeItem.dataset.path,
                    isDir: treeItem.dataset.isDir === 'true'
                };
                
                const menu = document.getElementById('contextMenu');
                menu.style.left = event.clientX + 'px';
                menu.style.top = event.clientY + 'px';
                menu.classList.add('active');
            }
        }

        function hideContextMenu() {
            document.getElementById('contextMenu').classList.remove('active');
        }

        function contextNewFile() {
            if (contextMenuTarget) {
                const path = contextMenuTarget.isDir ? contextMenuTarget.path : contextMenuTarget.path.split('/').slice(0, -1).join('/');
                createNewFile(path);
            }
            hideContextMenu();
        }

        function contextNewFolder() {
            if (contextMenuTarget) {
                const path = contextMenuTarget.isDir ? contextMenuTarget.path : contextMenuTarget.path.split('/').slice(0, -1).join('/');
                createNewFolder(path);
            }
            hideContextMenu();
        }

        function contextRename() {
            if (contextMenuTarget) {
                const newName = prompt('Enter new name:', contextMenuTarget.path.split('/').pop());
                if (newName) {
                    const basePath = contextMenuTarget.path.split('/').slice(0, -1).join('/');
                    renameFile(contextMenuTarget.path, `${basePath}/${newName}`);
                }
            }
            hideContextMenu();
        }

        async function renameFile(oldPath, newPath) {
            try {
                await fetch(`${API_BASE}/api/files/rename`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ old_path: oldPath, new_path: newPath })
                });
                await refreshExplorer();
            } catch (error) {
                alert('Error renaming: ' + error.message);
            }
        }

        function contextCopyPath() {
            if (contextMenuTarget) {
                navigator.clipboard.writeText(contextMenuTarget.path);
                showNotification('Path copied!', 'success');
            }
            hideContextMenu();
        }

        function contextDelete() {
            if (contextMenuTarget) {
                deleteFile(contextMenuTarget.path);
            }
            hideContextMenu();
        }

        // Placeholder functions for other panels
        function showSearch() { alert('Search coming soon!'); }
        function showGit() { alert('Git integration coming soon!'); }
        function showSettings() { alert('Settings coming soon!'); }
    </script>
</body>
</html>
