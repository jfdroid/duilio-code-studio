# CRUD - Create, Read, Update, Delete

## What is CRUD?

CRUD are the **4 basic operations** you can do with files:
- **C**reate
- **R**ead
- **U**pdate
- **D**elete

## How Does It Work in DuilioCode?

### 1. CREATE

#### Create File

**You ask:**
```
"create a file teste.txt with 'Hello World'"
```

**DuilioCode detects:**
- Intention: `create = True`
- Type: file
- Name: `teste.txt`
- Content: `Hello World`

**DuilioCode generates:**
```
```create-file:teste.txt
Hello World
```
```

**Action Processor executes:**
```python
# src/services/action_processor.py
def execute_create_file(path, content):
    Path(path).parent.mkdir(parents=True, exist_ok=True)
    Path(path).write_text(content)
```

**Result:**
✅ File `teste.txt` created successfully!

#### Create Directory

**You ask:**
```
"create the directory projeto-teste"
```

**DuilioCode detects:**
- Intention: `create_directory = True`
- Name: `projeto-teste`

**DuilioCode generates:**
```
```create-directory:projeto-teste
```
```

**Action Processor executes:**
```python
Path("projeto-teste").mkdir(parents=True, exist_ok=True)
```

**Result:**
✅ Directory `projeto-teste` created!

### 2. READ

**You ask:**
```
"show the content of the app.js file"
```

**DuilioCode detects:**
- Intention: `read = True`
- File: `app.js`

**DuilioCode reads:**
```python
# src/api/routes/chat/chat_handler.py
file_content = read_file("app.js", workspace_path)
```

**DuilioCode responds:**
```
The app.js file contains:

```javascript
function App() {
  return <div>Hello</div>;
}
```
```

### 3. UPDATE

**You ask:**
```
"add a validation function to the utils.js file"
```

**DuilioCode detects:**
- Intention: `update = True`
- File: `utils.js`
- Action: add function

**DuilioCode:**
1. Reads current file
2. Generates code with function added
3. Generates action:

```
```modify-file:utils.js
// Existing code + new function
function validateEmail(email) {
  return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
}
```
```

**Action Processor executes:**
```python
# Replaces entire file with new content
Path("utils.js").write_text(new_content)
```

**Result:**
✅ File updated!

### 4. DELETE

**You ask:**
```
"delete the teste.txt file"
```

**DuilioCode detects:**
- Intention: `delete = True`
- File: `teste.txt`

**DuilioCode generates:**
```
```delete-file:teste.txt
```
```

**Action Processor executes:**
```python
Path("teste.txt").unlink()  # Deletes file
```

**Result:**
✅ File deleted!

## Intention Detection

### How Do We Detect?

**Code**: `src/api/routes/chat/chat_handler.py`

```python
def _detect_crud_intent(self, message: str):
    message_lower = message.lower()
    
    create_keywords = [
        'create file', 'create folder',
        'create a', 'new file'
    ]
    
    read_keywords = [
        'read file', 'view file',
        'show file', 'file content'
    ]
    
    update_keywords = [
        'modify file', 'edit file', 'update',
        'add', 'change'
    ]
    
    delete_keywords = [
        'delete file', 'remove file',
        'delete', 'remove'
    ]
    
    return {
        'create': any(kw in message_lower for kw in create_keywords),
        'read': any(kw in message_lower for kw in read_keywords),
        'update': any(kw in message_lower for kw in update_keywords),
        'delete': any(kw in message_lower for kw in delete_keywords)
    }
```

## Action Formats

### CREATE FILE
```
```create-file:path/to/file.ext
[complete file content]
```
```

### CREATE DIRECTORY
```
```create-directory:path/to/dir
```
```

### MODIFY FILE
```
```modify-file:path/to/file.ext
[COMPLETE file content with changes]
```
```

### DELETE FILE
```
```delete-file:path/to/file.ext
```
```

### DELETE DIRECTORY
```
```delete-directory:path/to/dir
```
```

## Action Processor

### What Is It?

Action Processor is the **action executor**. It:
1. Reads actions generated by AI
2. Validates security (path traversal, etc.)
3. Executes on file system
4. Returns result

**Code**: `src/services/action_processor.py`

```python
class ActionProcessor:
    def extract_actions(self, response_text: str):
        # Looks for ```create-file:, ```modify-file:, etc.
        patterns = [
            r'```create-file:([^\n]+)\n([\s\S]*?)```',
            r'```create-directory:([^\n]+)```',
            # ...
        ]
        # Extracts all actions
        return actions
    
    async def process_actions(self, response_text, workspace_path):
        actions = self.extract_actions(response_text)
        
        for action in actions:
            if action['type'] == 'create-file':
                self.create_file(action['path'], action['content'])
            elif action['type'] == 'create-directory':
                self.create_directory(action['path'])
            # ...
        
        return {"success": True, "actions_executed": len(actions)}
```

## Security

### Validations

1. **Path Traversal**: Prevents `../../../etc/passwd`
2. **Workspace Boundary**: Only allows within workspace
3. **File Size**: File size limit
4. **Permissions**: Checks permissions before writing

**Code**: `src/core/security.py`

```python
def sanitize_path(path, workspace_path):
    # Remove path traversal
    if '../' in path:
        raise ValueError("Path traversal detected")
    
    # Ensures it's within workspace
    normalized = Path(path).resolve()
    workspace_root = Path(workspace_path).resolve()
    
    if not str(normalized).startswith(str(workspace_root)):
        raise ValueError("Path outside workspace")
    
    return str(normalized)
```

## Complete Examples

### Create Complete React Project

**Input:**
```
"create a complete React project called meu-app"
```

**Processing:**
1. Detects: `create = True`, `project = True`
2. Generates multiple actions:
   ```
   ```create-directory:meu-app
   ```
   ```create-file:meu-app/package.json
   {...}
   ```
   ```create-file:meu-app/src/index.js
   ...
   ```
   ```
3. Executes all actions
4. Complete project created!

### Modify Multiple Files

**Input:**
```
"add validation to all form files"
```

**Processing:**
1. Detects: `update = True`
2. Finds form files
3. Reads each file
4. Adds validation
5. Generates `modify-file` actions for each
6. Executes all

## Next Steps

- [Action Processor - Automatic Execution](14-action-processor.md)
- [Workspace Service - Project Management](15-workspace.md)
